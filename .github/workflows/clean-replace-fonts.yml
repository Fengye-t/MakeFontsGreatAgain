name: æ‰‹åŠ¨æ¸…ç† replace-fonts.yml å·¥ä½œæµå†å²è®°å½•
on:
  workflow_dispatch:
    inputs:
      workflow_status:
        type: choice
        description: "é€‰æ‹©è¦æ¸…ç†çš„å·¥ä½œæµçŠ¶æ€ï¼š"
        required: true
        options:
          - å¤±è´¥ (failed)
          - å–æ¶ˆ (cancelled)
          - æˆåŠŸ (success)
      days_old:
        type: number
        description: "æ¸…ç†å¤šå°‘å¤©å‰çš„è®°å½•ï¼Ÿï¼ˆ0 = æ¸…ç†æ‰€æœ‰è¯¥çŠ¶æ€è®°å½•ï¼Œéœ€ä¸ºéè´Ÿæ•´æ•°ï¼‰"
        required: true
        default: 7
      dry_run:
        type: boolean
        description: "æ˜¯å¦å¼€å¯æ¨¡æ‹Ÿæ¸…ç†ï¼Ÿ"
        required: true
        default: false

jobs:
  clean-workflow-runs:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£… GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update && sudo apt-get install -y gh

      - name: é…ç½® GitHub CLI è®¤è¯
        run: gh auth login --with-token <<< ${{ secrets.GITHUB_TOKEN }}

      - name: æ˜ å°„å·¥ä½œæµçŠ¶æ€
        id: map_status
        run: |
          case "${{ github.event.inputs.workflow_status }}" in
            "å¤±è´¥ (failed)") echo "STATUS=failed" >> $GITHUB_ENV ;;
            "å–æ¶ˆ (cancelled)") echo "STATUS=cancelled" >> $GITHUB_ENV ;;
            "æˆåŠŸ (success)") echo "STATUS=success" >> $GITHUB_ENV ;;
          esac

      - name: æ ¡éªŒå¹¶è½¬æ¢ days_old ä¸ºæ•´æ•°
        id: validate_days
        run: |
          DAYS_OLD=${{ github.event.inputs.days_old }}
          # è½¬æ¢ä¸ºæ•´æ•°ï¼ˆèˆå»å°æ•°éƒ¨åˆ†ï¼‰
          INT_DAYS=$(printf "%.0f" "$DAYS_OLD")
          
          # æ ¡éªŒæ˜¯å¦ä¸ºéè´Ÿæ•´æ•°
          if ! [[ "$INT_DAYS" =~ ^[0-9]+$ ]] || [ "$INT_DAYS" -lt 0 ]; then
            echo "âŒ é”™è¯¯ï¼šdays_old å¿…é¡»ä¸ºéè´Ÿæ•´æ•°ï¼Œå½“å‰å€¼ï¼š$DAYS_OLD"
            exit 1
          fi
          
          echo "INT_DAYS=$INT_DAYS" >> $GITHUB_ENV
          echo "âœ… days_old å·²è½¬æ¢ä¸ºæ•´æ•°ï¼š$INT_DAYS"

      - name: è®¡ç®—æ¸…ç†æ—¶é—´èŒƒå›´
        id: calc_time
        run: |
          INT_DAYS=${{ env.INT_DAYS }}
          if [ "$INT_DAYS" -eq 0 ]; then
            echo "SINCE=0" >> $GITHUB_ENV
            echo "ğŸ“… æ¸…ç†æ‰€æœ‰ ${STATUS} çŠ¶æ€çš„å·¥ä½œæµè®°å½•"
          else
            SINCE=$(date -d "$INT_DAYS days ago" +%s)
            echo "SINCE=$SINCE" >> $GITHUB_ENV
            echo "ğŸ“… æ¸…ç†æ—¶é—´èŒƒå›´ï¼š$(date -d "@$SINCE" +"%Y-%m-%d %H:%M:%S") ä¹‹å‰çš„ ${STATUS} è®°å½•"
          fi

      - name: è·å–å¾…æ¸…ç†çš„å·¥ä½œæµè®°å½• ID
        id: get_run_ids
        run: |
          OWNER=${{ github.repository_owner }}
          REPO=${{ github.event.repository.name }}
          WORKFLOW_FILE="replace-fonts.yml"

          WORKFLOW_ID=$(gh api repos/$OWNER/$REPO/actions/workflows --jq ".workflows[] | select(.path == \".github/workflows/$WORKFLOW_FILE\") | .id")
          if [ -z "$WORKFLOW_ID" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°å·¥ä½œæµæ–‡ä»¶ .github/workflows/$WORKFLOW_FILE"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°å·¥ä½œæµ IDï¼š$WORKFLOW_ID"

          RUN_IDS=$(gh api repos/$OWNER/$REPO/actions/workflows/$WORKFLOW_ID/runs \
            --paginate \
            --jq "[.workflow_runs[] | select(.conclusion == \"${{ env.STATUS }}\" and .created_at | sub(\"\\+.*\";\"\") | strptime(\"%Y-%m-%dT%H:%M:%S\") | mktime < ${{ env.SINCE }}) | .id] | join(\" \")")

          if [ -z "$RUN_IDS" ] || [ "$RUN_IDS" = "[]" ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•"
            echo "RUN_IDS=" >> $GITHUB_ENV
          else
            echo "âœ… æ‰¾åˆ° $(echo $RUN_IDS | wc -w) æ¡å¾…æ¸…ç†è®°å½•"
            echo "RUN_IDS=$RUN_IDS" >> $GITHUB_ENV
          fi

      - name: æ‰§è¡Œæ¸…ç†ï¼ˆæˆ–æ¨¡æ‹Ÿæ¸…ç†ï¼‰
        if: env.RUN_IDS != ''
        run: |
          OWNER=${{ github.repository_owner }}
          REPO=${{ github.event.repository.name }}
          DRY_RUN=${{ github.event.inputs.dry_run }}
          RUN_IDS=(${{ env.RUN_IDS }})

          echo "========================================"
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ“ æ¨¡æ‹Ÿæ¸…ç†æ¨¡å¼"
          else
            echo "âš ï¸ å®é™…æ¸…ç†æ¨¡å¼"
          fi
          echo "========================================"

          for ID in "${RUN_IDS[@]}"; do
            RUN_INFO=$(gh api repos/$OWNER/$REPO/actions/runs/$ID --jq "{created_at: .created_at, run_number: .run_number}")
            CREATED_AT=$(echo $RUN_INFO | jq -r .created_at | sed 's/T/ /; s/Z//')
            RUN_NUMBER=$(echo $RUN_INFO | jq -r .run_number)

            if [ "$DRY_RUN" = "true" ]; then
              echo "âœ… æ¨¡æ‹Ÿæ¸…ç†ï¼š#$RUN_NUMBERï¼ˆIDï¼š$IDï¼‰ï¼Œåˆ›å»ºæ—¶é—´ï¼š$CREATED_AT"
            else
              echo "ğŸ—‘ï¸ æ¸…ç†ä¸­ï¼š#$RUN_NUMBERï¼ˆIDï¼š$IDï¼‰ï¼Œåˆ›å»ºæ—¶é—´ï¼š$CREATED_AT"
              gh api repos/$OWNER/$REPO/actions/runs/$ID -X DELETE --confirm
              echo "âœ… æ¸…ç†å®Œæˆï¼šID $ID"
            fi
          done

          echo "========================================"
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ“ æ¨¡æ‹Ÿæ¸…ç†å®Œæˆï¼Œå…± ${#RUN_IDS[@]} æ¡è®°å½•"
          else
            echo "âœ… å®é™…æ¸…ç†å®Œæˆï¼Œå…± ${#RUN_IDS[@]} æ¡è®°å½•"
          fi
