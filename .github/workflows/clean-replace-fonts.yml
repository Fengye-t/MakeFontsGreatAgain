name: Clean Replace Fonts Workflow Runs
on:
  # 手动触发（在 GitHub Actions 页面点击运行）
  workflow_dispatch:
    inputs:
      # 可输入要保留的最新运行数量，默认为 5
      keep_latest_runs:
        description: 'Number of latest runs to keep'
        required: false
        default: '5'
  # 也可配置定时触发，比如每天凌晨 2 点运行
  # schedule:
  #   - cron: '0 2 * * *'

jobs:
  clean-workflow-runs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          # 安装 GitHub CLI
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
            && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
            && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
            && sudo apt update \
            && sudo apt install gh -y
          # 验证安装
          gh --version

      - name: Authenticate GitHub CLI
        run: |
          # 使用 GitHub Actions 提供的令牌进行认证
          gh auth login --with-token <<< ${{ secrets.GITHUB_TOKEN }}

      - name: List and Clean Workflow Runs
        run: |
          # 获取要保留的最新运行数量
          KEEP_LATEST=${{ github.event.inputs.keep_latest_runs || '5' }}
          # 获取 workflow_id，通过工作流文件名查找
          WORKFLOW_ID=$(gh api repos/${{ github.repository }}/actions/workflows --jq '.workflows[] | select(.path == ".github/workflows/replace-fonts.yml") | .id')
          if [ -z "$WORKFLOW_ID" ]; then
            echo "❌ 未找到 .github/workflows/replace-fonts.yml 对应的工作流ID"
            exit 1
          fi
          echo "找到工作流ID: $WORKFLOW_ID"
          # 获取该工作流的所有运行记录（按创建时间降序排列）
          RUNS=$(gh api repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs --method GET --paginate --jq '.workflow_runs | sort_by(.created_at) | reverse')
          # 计算需要删除的运行数量（总运行数 - 要保留的最新数量）
          TOTAL_RUNS=$(echo "$RUNS" | jq 'length')
          RUNS_TO_DELETE=$((TOTAL_RUNS - KEEP_LATEST))
          if [ "$RUNS_TO_DELETE" -le 0 ]; then
            echo "✅ 运行数量 $TOTAL_RUNS 小于等于要保留的数量 $KEEP_LATEST，无需清理"
            exit 0
          fi
          echo "将删除 $RUNS_TO_DELETE 条旧运行记录，保留最新的 $KEEP_LATEST 条"
          # 遍历要删除的运行记录并执行删除
          echo "$RUNS" | jq -r ".[$KEEP_LATEST:] | .[].id" | while read -r RUN_ID; do
            echo "正在删除运行ID: $RUN_ID"
            gh api repos/${{ github.repository }}/actions/runs/$RUN_ID -X DELETE
            echo "已删除运行ID: $RUN_ID"
          done
          echo "✅ 清理完成"
