name: æ‰‹åŠ¨æ¸…ç† replace-fonts.yml å·¥ä½œæµå†å²è®°å½•
on:
  workflow_dispatch:
    inputs:
      # æ‰‹åŠ¨é€‰æ‹©è¦æ¸…ç†çš„å·¥ä½œæµçŠ¶æ€ï¼ˆå¿…é€‰ï¼‰
      workflow_status:
        type: choice
        description: "é€‰æ‹©è¦æ¸…ç†çš„å·¥ä½œæµçŠ¶æ€ï¼š"
        required: true
        options:
          - å¤±è´¥ (failed)
          - å–æ¶ˆ (cancelled)
          - æˆåŠŸ (success)
      # å¯é€‰ï¼šæ¸…ç†æŒ‡å®šå¤©æ•°å‰çš„è®°å½•ï¼ˆé»˜è®¤7å¤©ï¼Œ0è¡¨ç¤ºæ¸…ç†æ‰€æœ‰è¯¥çŠ¶æ€è®°å½•ï¼‰
      days_old:
        type: number
        description: "æ¸…ç†å¤šå°‘å¤©å‰çš„è®°å½•ï¼Ÿï¼ˆ0 = æ¸…ç†æ‰€æœ‰è¯¥çŠ¶æ€è®°å½•ï¼‰"
        required: true
        default: 7
      # å¯é€‰ï¼šæ˜¯å¦æ¨¡æ‹Ÿæ¸…ç†ï¼ˆä»…å±•ç¤ºå¾…æ¸…ç†è®°å½•ï¼Œä¸å®é™…åˆ é™¤ï¼‰
      dry_run:
        type: boolean
        description: "æ˜¯å¦å¼€å¯æ¨¡æ‹Ÿæ¸…ç†ï¼Ÿï¼ˆå¼€å¯åä»…å±•ç¤ºå¾…æ¸…ç†è®°å½•ï¼Œä¸å®é™…åˆ é™¤ï¼‰"
        required: true
        default: false

jobs:
  clean-workflow-runs:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šå®‰è£… GitHub CLIï¼ˆç”¨äºæ“ä½œå·¥ä½œæµè®°å½•ï¼‰
      - name: å®‰è£… GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update && sudo apt-get install -y gh

      # æ­¥éª¤2ï¼šé…ç½® GitHub CLI è®¤è¯ï¼ˆä½¿ç”¨é»˜è®¤ Secrets.GITHUB_TOKENï¼‰
      - name: é…ç½® GitHub CLI è®¤è¯
        run: gh auth login --with-token <<< ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤3ï¼šæ˜ å°„é€‰æ‹©çš„çŠ¶æ€åˆ° GitHub API å¯¹åº”çš„çŠ¶æ€å€¼
      - name: æ˜ å°„å·¥ä½œæµçŠ¶æ€
        id: map_status
        run: |
          case "${{ github.event.inputs.workflow_status }}" in
            "å¤±è´¥ (failed)") echo "STATUS=failed" >> $GITHUB_ENV ;;
            "å–æ¶ˆ (cancelled)") echo "STATUS=cancelled" >> $GITHUB_ENV ;;
            "æˆåŠŸ (success)") echo "STATUS=success" >> $GITHUB_ENV ;;
          esac

      # æ­¥éª¤4ï¼šè®¡ç®—æ¸…ç†æ—¶é—´èŒƒå›´ï¼ˆå¤©æ•°è½¬æ¢ä¸ºæ—¶é—´æˆ³ï¼‰
      - name: è®¡ç®—æ¸…ç†æ—¶é—´èŒƒå›´
        id: calc_time
        run: |
          DAYS_OLD=${{ github.event.inputs.days_old }}
          if [ "$DAYS_OLD" -eq 0 ]; then
            # æ¸…ç†æ‰€æœ‰è¯¥çŠ¶æ€è®°å½•ï¼ˆæ—¶é—´æˆ³è®¾ä¸º0ï¼Œå³ä»çºªå…ƒæ—¶é—´å¼€å§‹ï¼‰
            echo "SINCE=0" >> $GITHUB_ENV
          else
            # è®¡ç®— N å¤©å‰çš„æ—¶é—´æˆ³ï¼ˆå•ä½ï¼šç§’ï¼‰
            SINCE=$(date -d "$DAYS_OLD days ago" +%s)
            echo "SINCE=$SINCE" >> $GITHUB_ENV
            echo "ğŸ“… æ¸…ç†æ—¶é—´èŒƒå›´ï¼š$(date -d "@$SINCE" +"%Y-%m-%d %H:%M:%S") ä¹‹å‰çš„ ${STATUS} è®°å½•"
          fi

      # æ­¥éª¤5ï¼šè·å–å¾…æ¸…ç†çš„ replace-fonts.yml å·¥ä½œæµè®°å½• ID
      - name: è·å–å¾…æ¸…ç†çš„å·¥ä½œæµè®°å½• ID
        id: get_run_ids
        run: |
          # ä»“åº“ä¿¡æ¯ï¼ˆOWNER/REPO è‡ªåŠ¨ä»å½“å‰ç¯å¢ƒè·å–ï¼Œæ— éœ€æ‰‹åŠ¨ä¿®æ”¹ï¼‰
          OWNER=${{ github.repository_owner }}
          REPO=${{ github.event.repository.name }}
          WORKFLOW_FILE="replace-fonts.yml"

          # 1. è·å– replace-fonts.yml çš„å·¥ä½œæµ IDï¼ˆé€šè¿‡æ–‡ä»¶ååŒ¹é…ï¼‰
          WORKFLOW_ID=$(gh api repos/$OWNER/$REPO/actions/workflows --jq ".workflows[] | select(.path == \".github/workflows/$WORKFLOW_FILE\") | .id")
          if [ -z "$WORKFLOW_ID" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°å·¥ä½œæµæ–‡ä»¶ .github/workflows/$WORKFLOW_FILE"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ° replace-fonts.yml å·¥ä½œæµ IDï¼š$WORKFLOW_ID"

          # 2. è·å–è¯¥å·¥ä½œæµä¸‹ç¬¦åˆæ¡ä»¶çš„è®°å½• IDï¼ˆçŠ¶æ€+æ—¶é—´èŒƒå›´ï¼‰
          echo "ğŸ” æ­£åœ¨æŸ¥è¯¢ ${STATUS} ä¸”æ—¶é—´åœ¨ $(date -d "@$SINCE" +"%Y-%m-%d") ä¹‹å‰çš„å·¥ä½œæµè®°å½•..."
          RUN_IDS=$(gh api repos/$OWNER/$REPO/actions/workflows/$WORKFLOW_ID/runs \
            --paginate \
            --jq "[.workflow_runs[] | select(.conclusion == \"$STATUS\" and .created_at | sub(\"\\+.*\";\"\") | strptime(\"%Y-%m-%dT%H:%M:%S\") | mktime < $SINCE) | .id] | join(\" \")")

          if [ -z "$RUN_IDS" ] || [ "$RUN_IDS" = "[]" ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å·¥ä½œæµè®°å½•ï¼Œæ— éœ€æ¸…ç†"
            echo "RUN_IDS=" >> $GITHUB_ENV
          else
            echo "âœ… æ‰¾åˆ° $(echo $RUN_IDS | wc -w) æ¡å¾…æ¸…ç†è®°å½•ï¼ŒIDï¼š$RUN_IDS"
            echo "RUN_IDS=$RUN_IDS" >> $GITHUB_ENV
          fi

      # æ­¥éª¤6ï¼šæ‰§è¡Œæ¸…ç†ï¼ˆæˆ–æ¨¡æ‹Ÿæ¸…ç†ï¼‰
      - name: æ‰§è¡Œæ¸…ç†ï¼ˆæˆ–æ¨¡æ‹Ÿæ¸…ç†ï¼‰
        if: env.RUN_IDS != ''
        run: |
          OWNER=${{ github.repository_owner }}
          REPO=${{ github.event.repository.name }}
          DRY_RUN=${{ github.event.inputs.dry_run }}
          RUN_IDS=(${{ env.RUN_IDS }})

          echo "========================================"
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ“ å¼€å¯æ¨¡æ‹Ÿæ¸…ç†æ¨¡å¼ï¼Œä»…å±•ç¤ºæ“ä½œï¼Œä¸å®é™…åˆ é™¤"
          else
            echo "âš ï¸ å¼€å¯å®é™…æ¸…ç†æ¨¡å¼ï¼Œå°†åˆ é™¤ä»¥ä¸‹å·¥ä½œæµè®°å½•"
          fi
          echo "========================================"

          # å¾ªç¯å¤„ç†æ¯æ¡å¾…æ¸…ç†è®°å½•
          for ID in "${RUN_IDS[@]}"; do
            # è·å–è¯¥è®°å½•çš„åˆ›å»ºæ—¶é—´å’Œè¿è¡Œç¼–å·ï¼Œæ–¹ä¾¿æ ¸å¯¹
            RUN_INFO=$(gh api repos/$OWNER/$REPO/actions/runs/$ID --jq "{created_at: .created_at, run_number: .run_number}")
            CREATED_AT=$(echo $RUN_INFO | jq -r .created_at | sed 's/T/ /; s/Z//')
            RUN_NUMBER=$(echo $RUN_INFO | jq -r .run_number)

            if [ "$DRY_RUN" = "true" ]; then
              echo "âœ… æ¨¡æ‹Ÿæ¸…ç†ï¼šè®°å½•ç¼–å· $RUN_NUMBERï¼ˆIDï¼š$IDï¼‰ï¼Œåˆ›å»ºæ—¶é—´ï¼š$CREATED_AT"
            else
              echo "ğŸ—‘ï¸ æ­£åœ¨æ¸…ç†ï¼šè®°å½•ç¼–å· $RUN_NUMBERï¼ˆIDï¼š$IDï¼‰ï¼Œåˆ›å»ºæ—¶é—´ï¼š$CREATED_AT"
              # å®é™…åˆ é™¤å·¥ä½œæµè®°å½•ï¼ˆ--confirm è·³è¿‡ç¡®è®¤æç¤ºï¼‰
              gh api repos/$OWNER/$REPO/actions/runs/$ID -X DELETE --confirm
              if [ $? -eq 0 ]; then
                echo "âœ… æ¸…ç†æˆåŠŸï¼šè®°å½• ID $ID"
              else
                echo "âŒ æ¸…ç†å¤±è´¥ï¼šè®°å½• ID $ID"
              fi
            fi
          done

          echo "========================================"
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ“ æ¨¡æ‹Ÿæ¸…ç†å®Œæˆï¼Œå…±å¤„ç† $(echo $RUN_IDS | wc -w) æ¡è®°å½•ï¼ˆæœªå®é™…åˆ é™¤ï¼‰"
          else
            echo "âœ… å®é™…æ¸…ç†å®Œæˆï¼Œå…±å¤„ç† $(echo $RUN_IDS | wc -w) æ¡è®°å½•"
          fi
