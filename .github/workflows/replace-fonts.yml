name: è‡ªåŠ¨æ›¿æ¢å­—ä½“å¹¶å‘å¸ƒReleaseï¼ˆå«æ•°å­—Tagè§¦å‘ç‰ˆï¼‰
on:
  push:
    tags:
      - '*'  # åŒ¹é…æ‰€æœ‰Tagï¼ˆçº¯æ•°å­—ã€å¸¦å­—æ¯ç­‰ï¼‰
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  replace-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å‘å¸ƒReleaseéœ€è¦çš„æƒé™
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: true  # ä¿ç•™å‡­è¯ï¼Œé¿å…åç»­æƒé™ä¸è¶³

      # æ­¥éª¤2ï¼šè·å–å¹¶è§£å‹æœ€æ–°MFGAæ¨¡å—ï¼ˆä¿®å¤7zå‚æ•°+è·¯å¾„å®šä½ï¼‰
      - name: è‡ªåŠ¨è·å–å¹¶ä¸‹è½½æœ€æ–°MFGAæ¨¡å—
        run: |
          # 1. è·å–æ¨¡å—é“¾æ¥
          MODULE_URL=$(curl -s "https://api.github.com/repos/Fengye-t/MakeFontsGreatAgain/releases/latest" | jq -r '.assets[] | select(.name | endswith(".zip") and contains("MFGA")) | .browser_download_url')
          if [ -z "$MODULE_URL" ] || [ "$MODULE_URL" = "null" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°å«MFGAå…³é”®è¯çš„.zipæ¨¡å—"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°MFGAæ¨¡å—é“¾æ¥ï¼š$MODULE_URL"

          # 2. ä¸‹è½½+å®Œæ•´æ€§æ ¡éªŒ
          wget -O mfga-latest-module.zip "$MODULE_URL" --no-verbose --tries=3 --timeout=30
          if [ ! -f "mfga-latest-module.zip" ] || [ $(stat -c%s "mfga-latest-module.zip") -lt 1024 ]; then
            echo "âŒ é”™è¯¯ï¼šæ¨¡å—ä¸‹è½½ä¸å®Œæ•´æˆ–æŸå"
            exit 1
          fi

          # 3. å®‰è£…å·¥å…·+è§£å‹ï¼ˆä¿®å¤7zå‚æ•°ï¼Œç”¨-xr!æ’é™¤ç¬¦å·é“¾æ¥ï¼‰
          sudo apt-get update && sudo apt-get install -y p7zip-full tree
          mkdir -p extracted-latest-module
          7z x mfga-latest-module.zip -oextracted-latest-module -xr!*.lnk -xr!*.symlink  # ä¿®å¤åçš„7zå‘½ä»¤

          # 4. è‡ªåŠ¨å®šä½å­—ä½“ç›®å½•
          FONT_DIR=$(find extracted-latest-module -type d -name "fonts" | grep "system/fonts" | head -n1)
          if [ -z "$FONT_DIR" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° system/fonts ç›®å½•ï¼Œè§£å‹ç»“æ„ï¼š"
            tree extracted-latest-module
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°å­—ä½“ç›®å½•ï¼š$FONT_DIR"
          echo "FONT_DIR=$FONT_DIR" >> $GITHUB_ENV  # å­˜å…¥ç¯å¢ƒå˜é‡ï¼Œåç»­æ­¥éª¤å¤ç”¨

      # æ­¥éª¤3ï¼šæ›¿æ¢ç‰¹å®šRobotoå­—ä½“æ–‡ä»¶ï¼ˆæ ¡éªŒå­—ä½“å­˜åœ¨æ€§ï¼‰
      - name: æ›¿æ¢ç‰¹å®šRobotoå­—ä½“æ–‡ä»¶
        run: |
          TARGET_FONT_DIR="system/fonts"
          mkdir -p "$TARGET_FONT_DIR"

          # æ ¡éªŒåŸå§‹æ¨¡å—ä¸­ç›®æ ‡å­—ä½“æ˜¯å¦å­˜åœ¨
          REQUIRED_FONTS=("RobotoFlex-Regular.ttf" "Roboto-Regular.ttf" "Roboto-Italic.ttf")
          for FONT in "${REQUIRED_FONTS[@]}"; do
            if [ ! -f "${{ env.FONT_DIR }}/$FONT" ]; then
              echo "âŒ é”™è¯¯ï¼šåŸå§‹æ¨¡å—ç¼ºå¤±å­—ä½“ $FONT"
              exit 1
            fi
          done

          # å¤åˆ¶ç›®æ ‡å­—ä½“
          cp -f "${{ env.FONT_DIR }}/"*.ttf "$TARGET_FONT_DIR/"
          echo "âœ… å­—ä½“æ›¿æ¢å®Œæˆï¼Œç›®æ ‡ç›®å½•æ–‡ä»¶ï¼š"
          ls -l "$TARGET_FONT_DIR"

      # æ­¥éª¤4ï¼šæ„å»ºMFGAæ›´æ–°åŒ…ï¼ˆä¿®å¤æ¨¡å—æ ¹ç›®å½•æ ¡éªŒ+cpé€’å½’å¤åˆ¶ï¼‰
      - name: æ„å»ºMFGAæ›´æ–°åŒ…
        run: |
          MODULE_ROOT="extracted-latest-module"
          # æ ¡éªŒMODULE_ROOTéç©ºä¸”systemç›®å½•å­˜åœ¨
          if [ -z "$MODULE_ROOT" ] || [ ! -d "$MODULE_ROOT/system" ]; then  
            echo "âŒ é”™è¯¯ï¼šæ¨¡å—æ ¹ç›®å½•ç»“æ„å¼‚å¸¸æˆ–MODULE_ROOTæœªè®¾ç½®ï¼Œå½“å‰ç»“æ„ï¼š"
            ls -al "$MODULE_ROOT"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°æ¨¡å—æ ¹ç›®å½•ï¼š$MODULE_ROOT"

          # ä¸´æ—¶ç›®å½•+æƒé™å¤„ç†
          mkdir -p temp-build
          # ä½¿ç”¨cp -Ré€’å½’å¤åˆ¶ç›®å½•
          sudo cp -R --no-preserve=mode "$MODULE_ROOT"/* temp-build/
          sudo chmod -R 755 temp-build/

          # è¦†ç›–å­—ä½“
          sudo cp -f "$TARGET_FONT_DIR"/* "temp-build/system/fonts/"

          # æ‰“åŒ…ï¼ˆæ’é™¤æ— æ•ˆæ–‡ä»¶ï¼‰
          cd temp-build
          zip -r "../MakeFontsGreatAgain-Updated.zip" ./* -x ".*" -x "__MACOSX/*"
          cd ..

          # æ ¡éªŒåŒ…æœ‰æ•ˆæ€§
          if [ ! -f "MakeFontsGreatAgain-Updated.zip" ] || [ $(stat -c%s "MakeFontsGreatAgain-Updated.zip") -lt 1024 ]; then
            echo "âŒ é”™è¯¯ï¼šæ›´æ–°åŒ…æ„å»ºå¤±è´¥"
            exit 1
          fi
          sudo chmod 644 "MakeFontsGreatAgain-Updated.zip"
          echo "âœ… MFGAæ›´æ–°åŒ…æ„å»ºå®Œæˆï¼šMakeFontsGreatAgain-Updated.zip"
          unzip -l "MakeFontsGreatAgain-Updated.zip" | grep -E "Roboto|system/fonts|META-INF"

      # æ­¥éª¤5ï¼šå‘å¸ƒåˆ°å…³è”Tagçš„Releaseï¼ˆæ”¯æŒè¦†ç›–å·²æœ‰Releaseï¼‰
      - name: å‘å¸ƒæ›´æ–°åŒ…åˆ°GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: "MakeFontsGreatAgain-Updated.zip"
          tag_name: ${{ github.ref_name }}  # å…³è”è§¦å‘çš„Tag
          append_body: |
            ### ğŸ“¦ è‡ªåŠ¨æ›´æ–°è¯´æ˜
            - ä»…æ›´æ–° **Robotoç³»åˆ—å­—ä½“**ï¼ˆRobotoFlex-Regular.ttfã€Roboto-Regular.ttfã€Roboto-Italic.ttfï¼‰
            - ä¿ç•™åŸå§‹MFGAæ¨¡å—æ‰€æœ‰æ–‡ä»¶ç»“æ„ï¼Œæ— é¢å¤–ä¿®æ”¹
          retry-count: 3  # å‘å¸ƒå¤±è´¥æ—¶é‡è¯•3æ¬¡
          retry-delay: 10  # é‡è¯•é—´éš”10ç§’
          overwrite: true  # å…è®¸è¦†ç›–å·²æœ‰åŒåTagçš„Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
