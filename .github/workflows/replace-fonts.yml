name: 自动替换字体并发布Release（含数字Tag触发版）
on:
  push:
    tags:
      - '*'  # 匹配所有Tag
  workflow_dispatch:

jobs:
  replace-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # 步骤1：检出仓库代码
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: true

      # 步骤2：获取并解压最新MFGA模块
      - name: 自动获取并下载最新MFGA模块
        run: |
          # 1. 获取模块链接（仅从官方GitHub仓库获取）
          MODULE_URL=$(curl -s "https://api.github.com/repos/Fengye-t/MakeFontsGreatAgain/releases/latest" \
            | jq -r '.assets[] | select(.name | endswith(".zip")) | .browser_download_url')
          
          if [ -z "$MODULE_URL" ] || [ "$MODULE_URL" = "null" ]; then
            echo " 错误：未找到官方MFGA模块资源"
            exit 1
          fi
          echo " 获取官方MFGA模块：$MODULE_URL"

          # 2. 下载正版资源
          wget -O mfga-official-module.zip "$MODULE_URL"
          if [ $(stat -c%s "mfga-official-module.zip") -lt 1024 ]; then
            echo " 错误：官方资源下载失败"
            exit 1
          fi

          # 3. 解压官方资源
          sudo apt-get update && sudo apt-get install -y p7zip-full
          mkdir -p extracted-module
          7z x mfga-official-module.zip -oextracted-module -y

          # 4. 定位字体目录
          FONT_DIR=$(find extracted-module -type d -name "fonts" | grep "system/fonts" | head -n1)
          if [ -z "$FONT_DIR" ]; then
            echo " 错误：官方资源结构异常"
            find extracted-module -type d | sort
            exit 1
          fi
          echo "FONT_DIR=$FONT_DIR" >> $GITHUB_ENV

      # 步骤3：替换字体文件（Roboto版权归Google所有）
      - name: 替换Roboto字体
        run: |
          # 重要提示：Roboto字体为Google官方版权，仅用于合法替换
          mkdir -p system/fonts
          
          FONTS=(
            "RobotoFlex-Regular.ttf"
            "Roboto-Regular.ttf"
            "Roboto-Italic.ttf"
          )
          
          for font in "${FONTS[@]}"; do
            src="${{ env.FONT_DIR }}/$font"
            dest="system/fonts/$font"
            
            if [ ! -f "$src" ]; then
              echo "️ 警告：官方资源未包含 $font"
            else
              cp "$src" "$dest"
              echo " 合法替换 $font"
            fi
          done

      # 步骤4：构建更新包（修正核心错误）
      - name: 构建MFGA更新包
        run: |
          # 重建官方模块结构
          mkdir -p build-output/system/fonts
          
          # 复制原始文件（不含字体）
          cp -r extracted-module/* build-output/
          
          # 覆盖字体文件
          cp system/fonts/* build-output/${{ env.FONT_DIR }}/
          
          # 创建合法发布包
          cd build-output
          zip -r9 ../MakeFontsGreatAgain-Updated.zip *
          cd ..
          
          # 版权信息验证
          echo "️ 最终包文件版权信息："
          unzip -Z -1 MakeFontsGreatAgain-Updated.zip | grep -e 'META-INF' -e 'fonts'

      # 步骤5：发布正版资源
      - name: 发布正版资源
        uses: softprops/action-gh-release@v1
        with:
          files: MakeFontsGreatAgain-Updated.zip
          tag_name: ${{ github.ref_name }}
          body: |
            ###  正版资源声明
            本模块仅包含来自官方MFGA仓库的资源与合法替换的Roboto字体。
            请遵循原始项目及Google的字体使用条款。
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
