name: è‡ªåŠ¨æ›¿æ¢å­—ä½“å¹¶å‘å¸ƒReleaseï¼ˆå«æ•°å­—Tagè§¦å‘ç‰ˆï¼‰
on:
  push:
    tags:
      - '*[0-9]*'  # Tagä¸­åŒ…å«ä»»æ„æ•°å­—å³è§¦å‘ï¼ˆå¦‚v1.0ã€mfga2024ã€v3-betaç­‰ï¼‰
  workflow_dispatch: # ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•

jobs:
  replace-and-release:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # æ­¥éª¤2ï¼šè·å–å¹¶è§£å‹æœ€æ–°Releaseçš„MFGAæ¨¡å—ï¼ˆç­›é€‰å«MFGAçš„.zipï¼‰
      - name: è‡ªåŠ¨è·å–å¹¶ä¸‹è½½æœ€æ–°MFGAæ¨¡å—
        run: |
          # è·å–æœ€æ–°Releaseä¸­å«"MFGA"å…³é”®è¯çš„.zipæ¨¡å—é“¾æ¥
          MODULE_URL=$(curl -s "https://api.github.com/repos/Fengye-t/MakeFontsGreatAgain/releases/latest" | jq -r '.assets[] | select(.name | endswith(".zip") and contains("MFGA")) | .browser_download_url')
          
          # æ ¡éªŒæ¨¡å—é“¾æ¥æœ‰æ•ˆæ€§
          if [ -z "$MODULE_URL" ] || [ "$MODULE_URL" = "null" ]; then
            echo "âŒ é”™è¯¯ï¼šæœ€æ–°Releaseä¸­æœªæ‰¾åˆ°å«MFGAå…³é”®è¯çš„.zipæ¨¡å—"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°MFGAæ¨¡å—é“¾æ¥ï¼š$MODULE_URL"
          
          # ä¸‹è½½æ¨¡å—ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
          wget -O mfga-latest-module.zip "$MODULE_URL" --no-verbose --tries=3 --timeout=30
          
          # å®‰è£…7zå¹¶è§£å‹æ¨¡å—
          sudo apt-get update && sudo apt-get install -y p7zip-full
          7z x mfga-latest-module.zip -oextracted-latest-module
          
          # éªŒè¯å­—ä½“ç›®å½•å­˜åœ¨
          FONT_DIR="extracted-latest-module/system/fonts"
          if [ ! -d "$FONT_DIR" ]; then
            echo "âŒ é”™è¯¯ï¼šMFGAæ¨¡å—è§£å‹åæœªæ‰¾åˆ°å­—ä½“ç›®å½• $FONT_DIR"
            exit 1
          fi
          echo "âœ… MFGAæ¨¡å—å­—ä½“ç›®å½•å­˜åœ¨ï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -l "$FONT_DIR"

      # æ­¥éª¤3ï¼šæ›¿æ¢ç‰¹å®šRobotoå­—ä½“æ–‡ä»¶ï¼ˆä»…æ›´æ–°ç›®æ ‡å­—ä½“ï¼‰
      - name: æ›¿æ¢ç‰¹å®šRobotoå­—ä½“æ–‡ä»¶
        run: |
          EXTRACTED_FONT_DIR="extracted-latest-module/system/fonts"
          TARGET_FONT_DIR="system/fonts"
          mkdir -p "$TARGET_FONT_DIR"
          
          # ä»…å¤åˆ¶3ä¸ªç‰¹å®šRobotoå­—ä½“
          cp -f "$EXTRACTED_FONT_DIR/RobotoFlex-Regular.ttf" "$TARGET_FONT_DIR/"
          cp -f "$EXTRACTED_FONT_DIR/Roboto-Regular.ttf" "$TARGET_FONT_DIR/"
          cp -f "$EXTRACTED_FONT_DIR/Roboto-Italic.ttf" "$TARGET_FONT_DIR/"
          
          echo "âœ… ç‰¹å®šRobotoå­—ä½“æ›¿æ¢å®Œæˆï¼Œç›®æ ‡ç›®å½•æ–‡ä»¶ï¼š"
          ls -l "$TARGET_FONT_DIR"

      # æ­¥éª¤4ï¼šæ„å»ºæ¨¡å—å‹ç¼©åŒ…ï¼ˆä¿ç•™åŸå§‹æ–‡ä»¶ï¼Œä»…æ›´æ–°å­—ä½“ï¼‰
      - name: æ„å»ºMFGAæ›´æ–°åŒ…
        run: |
          MODULE_NAME="MakeFontsGreatAgain-Updated.zip"
          
          # è§£å‹åŸå§‹æ¨¡å—åˆ°ä¸´æ—¶ç›®å½•ï¼ˆä¿ç•™æ‰€æœ‰æ–‡ä»¶ï¼‰
          mkdir -p temp-original-module
          7z x mfga-latest-module.zip -otemp-original-module
          
          # è¦†ç›–å­—ä½“æ–‡ä»¶ï¼ˆä»…æ›´æ–°å­—ä½“ï¼Œå…¶ä»–æ–‡ä»¶ä¸å˜ï¼‰
          cp -rf "$TARGET_FONT_DIR"/* "temp-original-module/system/fonts/"
          
          # é‡æ–°æ‰“åŒ…
          cd temp-original-module
          zip -r "../$MODULE_NAME" ./*
          cd ..
          
          echo "âœ… MFGAæ›´æ–°åŒ…æ„å»ºå®Œæˆï¼š$MODULE_NAME"
          # éªŒè¯å…³é”®æ–‡ä»¶
          echo "ğŸ“ éªŒè¯æ›´æ–°åŒ…å†…å®¹ï¼š"
          unzip -l "$MODULE_NAME" | grep -E "Roboto|system/fonts|META-INF"

      # æ­¥éª¤5ï¼šå‘å¸ƒåˆ°å…³è”Tagçš„Release
      - name: å‘å¸ƒæ›´æ–°åŒ…åˆ°GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: "MakeFontsGreatAgain-Updated.zip"
          tag_name: ${{ github.ref_name }}  # è‡ªåŠ¨å…³è”è§¦å‘å·¥ä½œæµçš„Tag
          append_body: |
            ### ğŸ“¦ è‡ªåŠ¨æ›´æ–°è¯´æ˜
            - ä»…æ›´æ–° **Robotoç³»åˆ—å­—ä½“**ï¼ˆRobotoFlex-Regular.ttfã€Roboto-Regular.ttfã€Roboto-Italic.ttfï¼‰
            - ä¿ç•™åŸå§‹MFGAæ¨¡å—æ‰€æœ‰æ–‡ä»¶ç»“æ„ï¼Œæ— é¢å¤–ä¿®æ”¹
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
