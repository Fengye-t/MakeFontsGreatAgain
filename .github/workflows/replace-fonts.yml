name: 替换模块字体文件并构建Release
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  replace-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 新增步骤：从Release下载Magisk模块（需替换为实际模块URL或自动获取最新Release）
      - name: 下载Release中的Magisk模块
        run: |
          # 方案1：手动指定模块URL（推荐，从Release页面复制目标模块.zip的下载链接）
          wget -O mfga-module.zip "https://github.com/Fengye-t/MakeFontsGreatAgain/releases/download/v15.9.0/MakeFontsGreatAgain-v15.9.0.zip"
          # 方案2：自动获取最新Release的模块（若模块是最新Release的唯一.zip文件）
          # wget -O mfga-module.zip $(curl -s https://api.github.com/repos/Fengye-t/MakeFontsGreatAgain/releases/latest | jq -r '.assets[] | select(.name | endswith(".zip")) | .browser_download_url')
          
          # 创建临时目录，提取模块中的字体文件
          mkdir -p ./extracted-module # 用于存放解压后的模块文件
          unzip mfga-module.zip -d ./extracted-module # 解压模块到临时目录
          echo "模块解压完成，字体文件路径（需确认）："
          ls -l ./extracted-module/system/fonts/ # 验证字体是否在该路径（若路径不同需修改）

      - name: 准备新字体文件（从解压的模块中读取）
        run: |
          # 核心修改：从解压的模块目录（./extracted-module/system/fonts/）复制新字体到目标路径
          # 1. 替换4个指定字体（保持原文件名不变）
          cp ./extracted-module/system/fonts/NotoSansSC.ttf ./system/fonts/NotoSansSC.ttf
          cp ./extracted-module/system/fonts/RobotoFlex-Regular.ttf ./system/fonts/RobotoFlex-Regular.ttf
          cp ./extracted-module/system/fonts/Roboto-Regular.ttf ./system/fonts/Roboto-Regular.ttf
          cp ./extracted-module/system/fonts/Roboto-Italic.ttf ./system/fonts/Roboto-Italic.ttf
          
          # 2. 删除冗余文件
          rm -f ./system/fonts/SysSans-En-Regular.ttf ./system/fonts/SysFont-Regular.ttf
          
          # 3. 验证结果
          echo "替换后目标目录文件列表："
          ls -l ./system/fonts/

      - name: 构建模块压缩包（包含替换后的字体）
        run: |
          cd ./
          zip -r MakeFontsGreatAgain-Module-Updated.zip ./system ./META-INF ./action.sh ./update.json # 按需保留模块必要文件

      - name: 发布到Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          release_name: 模块版本 ${{ github.ref_name }}（已从Release模块替换字体）
          files: MakeFontsGreatAgain-Module-Updated.zip
          body: |
            1. 从Release下载Magisk模块并提取字体
            2. 替换 ./system/fonts/ 下4个字体文件（保留原命名）
            3. 删除 SysSans-En-Regular.ttf 和 SysFont-Regular.ttf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
